{% extends "base.html" %}
{% load static %}

{% block title %}Security Dashboard{% endblock %}
{% block page_title %}Security Dashboard{% endblock %}

{% block content %}
<style>
/* Dark Prison Theme - Security Dashboard with Enhanced Emergency System */
:root {
    --bg-dark: #1a1a1a;
    --bg-card: #2d2d2d;
    --bg-input: #404040;
    --bg-accent: #363636;
    --bg-table-row: #333333;
    --border: #555;
    --text-white: #ffffff;
    --text-bright: #f8f9fa;
    --text-light: #e9ecef;
    --text-muted: #d1d5db;
    --text-gray: #9ca3af;
    --name-black: #000000;
    --primary: #0066cc;
    --success: #28a745;
    --warning: #ffc107;
    --danger: #dc3545;
    --info: #17a2b8;
}

body {
    background: var(--bg-dark) !important;
    color: var(--text-white) !important;
}

/* Enhanced Emergency Button */
.emergency-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    animation: emergencyPulse 2s infinite;
    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.8) !important;
    background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%) !important;
    border: 3px solid #fff !important;
    color: white !important;
    font-weight: 800 !important;
    padding: 1.2rem 2rem !important;
    border-radius: 50px !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
    font-size: 1rem !important;
    transition: all 0.3s ease !important;
}

.emergency-btn:hover {
    transform: scale(1.1) !important;
    box-shadow: 0 8px 25px rgba(220, 53, 69, 1) !important;
    background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%) !important;
    color: white !important;
}

.emergency-btn.activated {
    animation: emergencyActivated 1s infinite !important;
    background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%) !important;
}

@keyframes emergencyPulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.8);
    }
    50% { 
        transform: scale(1.05);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 1);
    }
    100% { 
        transform: scale(1);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.8);
    }
}

@keyframes emergencyActivated {
    0%, 100% { 
        background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
        transform: scale(1.1);
    }
    50% { 
        background: linear-gradient(135deg, #ffffff 0%, #ff0000 100%);
        transform: scale(1.15);
    }
}

/* Emergency Modal Styles */
.emergency-modal .modal-content {
    background: var(--bg-card) !important;
    border: 3px solid var(--danger) !important;
    color: var(--text-white) !important;
}

.emergency-modal .modal-header {
    background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%) !important;
    color: white !important;
    border-bottom: 2px solid var(--border) !important;
}

.emergency-modal .modal-body {
    background: transparent !important;
    padding: 2rem !important;
}

.emergency-warning {
    background: rgba(220, 53, 69, 0.1) !important;
    border: 2px solid var(--danger) !important;
    border-radius: 8px !important;
    padding: 1.5rem !important;
    margin-bottom: 1.5rem !important;
    text-align: center !important;
}

.emergency-icon {
    font-size: 4rem !important;
    color: var(--danger) !important;
    animation: shake 0.5s infinite !important;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* Emergency Alert Banner */
.emergency-alert-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1001;
    background: linear-gradient(90deg, var(--danger) 0%, #ff0000 50%, var(--danger) 100%) !important;
    color: white !important;
    padding: 1rem !important;
    text-align: center !important;
    font-weight: 800 !important;
    font-size: 1.2rem !important;
    animation: emergencyFlash 1s infinite !important;
    display: none !important;
}

@keyframes emergencyFlash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Security Status Alert */
.security-alert {
    background: linear-gradient(135deg, var(--info) 0%, #138496 100%) !important;
    border: 2px solid var(--border) !important;
    border-radius: 12px !important;
    color: white !important;
    margin-bottom: 2rem !important;
    padding: 1.5rem !important;
}

/* Stats Cards */
.stats-card {
    background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%) !important;
    color: white !important;
    border-radius: 12px !important;
    padding: 2rem !important;
    margin-bottom: 1.5rem !important;
    box-shadow: 0 6px 15px rgba(0, 102, 204, 0.4) !important;
    transition: all 0.3s ease !important;
}

.stats-card:hover {
    transform: translateY(-3px) !important;
    box-shadow: 0 10px 20px rgba(0, 102, 204, 0.5) !important;
}

.stats-card.pink {
    background: linear-gradient(135deg, #e91e63 0%, #ad1457 100%) !important;
    box-shadow: 0 6px 15px rgba(233, 30, 99, 0.4) !important;
}

.stats-card.pink:hover {
    box-shadow: 0 10px 20px rgba(233, 30, 99, 0.5) !important;
}

.stats-number {
    font-size: 2.5rem !important;
    font-weight: 800 !important;
    margin-bottom: 0.5rem !important;
}

/* QR Verification Card */
.qr-card {
    background: var(--bg-card) !important;
    border: 2px solid var(--border) !important;
    border-radius: 12px !important;
    box-shadow: 0 6px 12px rgba(0,0,0,0.4) !important;
    height: 100% !important;
}

.qr-card .card-header {
    background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%) !important;
    border-bottom: 2px solid var(--border) !important;
    color: white !important;
    padding: 1.5rem !important;
}

.qr-card .card-header h4 {
    color: white !important;
    font-weight: 700 !important;
    margin-bottom: 0 !important;
}

.qr-card .card-body {
    background: transparent !important;
    color: var(--text-white) !important;
    padding: 2rem !important;
}

/* File Upload Area */
.file-upload-area {
    border: 2px dashed var(--primary) !important;
    border-radius: 8px !important;
    padding: 1.5rem !important;
    text-align: center !important;
    margin-bottom: 1rem !important;
    transition: all 0.3s ease !important;
    background: var(--bg-input) !important;
}

.file-upload-area:hover {
    border-color: var(--success) !important;
    background: var(--bg-accent) !important;
}

/* Form Elements */
.form-label {
    color: var(--text-white) !important;
    font-weight: 600 !important;
}

.form-control {
    background: var(--bg-input) !important;
    border: 2px solid var(--border) !important;
    color: var(--text-white) !important;
    border-radius: 6px !important;
}

.form-control:focus {
    background: var(--bg-input) !important;
    border-color: var(--primary) !important;
    color: var(--text-white) !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 102, 204, 0.25) !important;
}

.form-text {
    color: var(--text-muted) !important;
}

/* Buttons */
.btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%) !important;
    border: none !important;
    color: white !important;
    font-weight: 600 !important;
}

.btn-success {
    background: linear-gradient(135deg, var(--success) 0%, #218838 100%) !important;
    border: none !important;
    color: white !important;
    font-weight: 600 !important;
}

.btn-warning {
    background: linear-gradient(135deg, var(--warning) 0%, #e0a800 100%) !important;
    border: none !important;
    color: #000 !important;
    font-weight: 600 !important;
}

.btn-danger {
    background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%) !important;
    border: none !important;
    color: white !important;
    font-weight: 600 !important;
}

.btn-outline-secondary {
    background: var(--bg-input) !important;
    border: 2px solid var(--border) !important;
    color: var(--text-white) !important;
}

.btn-outline-secondary:hover {
    background: var(--border) !important;
    color: var(--text-white) !important;
}

/* Dashboard Tables */
.dashboard-table-card {
    background: var(--bg-card) !important;
    border: 2px solid var(--border) !important;
    border-radius: 12px !important;
    box-shadow: 0 6px 12px rgba(0,0,0,0.4) !important;
    margin-bottom: 2rem !important;
}

.dashboard-table-card .card-header {
    background: linear-gradient(135deg, var(--success) 0%, #218838 100%) !important;
    border-bottom: 2px solid var(--border) !important;
    color: white !important;
    padding: 1.5rem !important;
}

.dashboard-table-card.info-header .card-header {
    background: linear-gradient(135deg, var(--info) 0%, #138496 100%) !important;
}

.dashboard-table-card .card-header h5 {
    color: white !important;
    font-weight: 700 !important;
    margin-bottom: 0 !important;
}

.dashboard-table-card .card-body {
    background: transparent !important;
    color: var(--text-white) !important;
    padding: 0 !important;
}

/* Table Styling */
.table {
    color: var(--text-white) !important;
    margin-bottom: 0 !important;
    background: transparent !important;
}

.table thead th {
    background: var(--bg-input) !important;
    color: var(--text-bright) !important;
    border-bottom: 2px solid var(--border) !important;
    border-top: none !important;
    padding: 1rem !important;
    font-weight: 700 !important;
    font-size: 0.9rem !important;
}

.table tbody tr {
    background: var(--bg-card) !important;
    border-bottom: 1px solid var(--border) !important;
    transition: all 0.3s ease !important;
}

.table tbody tr:hover {
    background: var(--bg-table-row) !important;
    transform: translateX(2px) !important;
}

.table tbody td {
    color: var(--text-bright) !important;
    border-top: 1px solid var(--border) !important;
    padding: 1rem !important;
    vertical-align: middle !important;
}

/* Visitor/Prisoner Names */
.visitor-name,
.prisoner-name {
    color: var(--name-black) !important;
    background: var(--text-white) !important;
    font-weight: 800 !important;
    font-size: 0.95rem !important;
    padding: 0.4rem 0.8rem !important;
    border-radius: 6px !important;
    display: inline-block !important;
    border: 1px solid var(--border) !important;
}

/* Badges */
.badge {
    font-weight: 600 !important;
    padding: 0.5rem 0.75rem !important;
    border-radius: 6px !important;
}

.security-badge {
    background: linear-gradient(45deg, var(--danger), #ef4444) !important;
    color: white !important;
    padding: 8px 16px !important;
    border-radius: 20px !important;
    font-size: 0.8rem !important;
    font-weight: bold !important;
    display: inline-block !important;
}

/* Verification Results */
.verification-card {
    border: 2px solid var(--success) !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3) !important;
}

.verification-card .card {
    background: var(--bg-card) !important;
    color: var(--text-white) !important;
}

.person-card {
    background: linear-gradient(135deg, var(--bg-input) 0%, var(--bg-accent) 100%) !important;
    border-radius: 12px !important;
    padding: 1.5rem !important;
    text-align: center !important;
    border: 2px solid var(--border) !important;
    color: var(--text-white) !important;
}

.visitor-photo, 
.prisoner-photo {
    border: 3px solid var(--success) !important;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4) !important;
    object-fit: cover !important;
}

.visitor-section {
    border-right: 2px solid var(--success) !important;
}

/* Debug Section */
.debug-layer {
    border-left: 4px solid !important;
    padding: 8px 12px !important;
    margin: 4px 0 !important;
    border-radius: 4px !important;
    background: var(--bg-input) !important;
}

.debug-pass {
    border-color: var(--success) !important;
    background: rgba(40, 167, 69, 0.1) !important;
}

.debug-fail {
    border-color: var(--danger) !important;
    background: rgba(220, 53, 69, 0.1) !important;
}

/* Alerts */
.alert {
    border-radius: 8px !important;
    border: 2px solid !important;
}

.alert-info {
    background: rgba(23, 162, 184, 0.1) !important;
    border-color: var(--info) !important;
    color: var(--info) !important;
}

.alert-primary {
    background: rgba(0, 102, 204, 0.1) !important;
    border-color: var(--primary) !important;
    color: var(--primary) !important;
}

.alert-warning {
    background: rgba(255, 193, 7, 0.1) !important;
    border-color: var(--warning) !important;
    color: var(--warning) !important;
}

.alert-danger {
    background: rgba(220, 53, 69, 0.1) !important;
    border-color: var(--danger) !important;
    color: var(--danger) !important;
}

.alert-success {
    background: rgba(40, 167, 69, 0.1) !important;
    border-color: var(--success) !important;
    color: var(--success) !important;
}

.alert-secondary {
    background: var(--bg-input) !important;
    border-color: var(--border) !important;
    color: var(--text-muted) !important;
}

/* Empty States */
.empty-state {
    text-align: center !important;
    padding: 3rem 2rem !important;
    color: var(--text-muted) !important;
}

/* Progress Bar */
.progress {
    background: var(--bg-input) !important;
}

.progress-bar {
    background: var(--primary) !important;
}

/* Responsive Design */
@media (max-width: 768px) {
    .visitor-section {
        border-right: none !important;
        border-bottom: 2px solid var(--success) !important;
        margin-bottom: 20px !important;
    }
    
    .stats-number {
        font-size: 2rem !important;
    }
    
    .qr-card .card-body,
    .dashboard-table-card .card-body {
        padding: 1rem !important;
    }
    
    .emergency-btn {
        bottom: 15px !important;
        right: 15px !important;
        padding: 1rem 1.5rem !important;
        font-size: 0.9rem !important;
    }
}
</style>

<!-- Emergency Alert Banner (Hidden by default) -->
<div id="emergency-alert-banner" class="emergency-alert-banner">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    üö® FACILITY EMERGENCY ALERT ACTIVATED üö® - ALL SECURITY PERSONNEL RESPOND IMMEDIATELY
</div>

<!-- Security Status Alert -->
<div class="alert security-alert mb-4">
    <div class="d-flex align-items-center">
        <i class="bi bi-shield-check-fill fs-4 me-3"></i>
        <div>
            <strong>Security Dashboard Active</strong>
            <p class="mb-0">Multi-layer QR verification: Format ‚Üí Database ‚Üí Status ‚Üí Facility ‚Üí Date ‚Üí Duplicate checks</p>
        </div>
    </div>
</div>

<!-- Debug Section (Hidden by default) -->
<div class="col-12 mb-4" id="debug-section" style="display: none;">
    <div class="card" style="background: var(--bg-card); border: 2px solid var(--warning); color: var(--text-white);">
        <div class="card-header" style="background: var(--warning); color: #000;">
            <h5 class="mb-0">
                <i class="bi bi-bug me-2"></i>QR Validation Debug Information
                <button class="btn btn-sm btn-outline-dark float-end" onclick="hideDebug()">
                    <i class="bi bi-x"></i> Hide
                </button>
            </h5>
        </div>
        <div class="card-body">
            <div id="debug-output"></div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="stats-card text-center">
            <div class="stats-number">{{ current_visitor_count|default:0 }}</div>
            <div><i class="bi bi-people-fill me-2"></i>Visitors Currently Inside</div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="stats-card pink text-center">
            <div class="stats-number">{{ approved_visits|length|default:0 }}</div>
            <div><i class="bi bi-calendar-check me-2"></i>Approved for Today</div>
        </div>
    </div>
</div>

<div class="row">
    <!-- QR Code Verification Section -->
    <div class="col-lg-5 mb-4">
        <div class="card qr-card shadow-sm h-100">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-qr-code-scan me-2"></i>
                    Secure QR Code Check-In
                </h4>
            </div>
            <div class="card-body">
                <!-- Upload Section -->
                <div class="mb-3">
                    <label for="qr-image-input" class="form-label fw-bold">
                        <i class="bi bi-cloud-upload me-2"></i>1. Upload QR Code Image
                    </label>
                    <div class="file-upload-area">
                        <div class="input-group">
                            <input class="form-control" type="file" id="qr-image-input" accept="image/*">
                            <button class="btn btn-primary" type="button" id="verify-qr-button" disabled>
                                <i class="bi bi-search me-1"></i>Verify
                            </button>
                        </div>
                        <div class="form-text mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            Select QR code image, then click "Verify" for security validation
                        </div>
                    </div>
                </div>

                <!-- Debug Button -->
                <div class="mb-3">
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="debug-toggle-btn" style="display: none;">
                        <i class="bi bi-bug me-1"></i>Show Debug Info
                    </button>
                </div>

                <!-- Verification Results -->
                <div id="verification-area" class="mt-3">
                    <div class="alert alert-secondary text-center">
                        <i class="bi bi-shield-check fs-3 text-muted"></i>
                        <p class="mb-2 mt-2"><strong>Multi-Layer Security Verification</strong></p>
                        <p class="mb-0 small">Upload QR code to begin 6-layer authentication process</p>
                    </div>
                </div>

                <!-- Hidden Check-in Form -->
                <form method="post" action="{% url 'check_in_visitor' %}" id="checkin-form" style="display: none;">
                    {% csrf_token %}
                    <input type="hidden" name="visit_id" id="visit_id_input">
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Tables -->
    <div class="col-lg-7">
        <!-- Currently Inside Visitors -->
        <div class="card dashboard-table-card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-person-check-fill me-2"></i>
                    Visitors Currently Inside ({{ current_visitor_count|default:0 }})
                </h5>
            </div>
            <div class="card-body">
                {% if currently_inside %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-person me-1"></i>Visitor</th>
                                    <th><i class="bi bi-building me-1"></i>Prisoner</th>
                                    <th><i class="bi bi-clock me-1"></i>Check-In</th>
                                    <th class="text-end"><i class="bi bi-gear me-1"></i>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for visit in currently_inside %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if visit.visitor.profile_photo %}
                                                <img src="{{ visit.visitor.profile_photo.url }}" 
                                                     class="rounded-circle me-2" width="32" height="32" alt="Photo">
                                            {% else %}
                                                <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center" 
                                                     style="width: 32px; height: 32px; color: white; font-size: 14px;">
                                                    {{ visit.visitor.full_name|default:visit.visitor.username|first|upper }}
                                                </div>
                                            {% endif %}
                                            <div>
                                                <div class="visitor-name" style="color: #000000 !important; background: #ffffff !important;">
                                                    {{ visit.visitor.full_name|default:visit.visitor.username }}
                                                </div>
                                                {% if visit.visitor.phone_number %}
                                                    <small class="text-muted">{{ visit.visitor.phone_number }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="prisoner-name" style="color: #000000 !important; background: #ffffff !important;">
                                            {{ visit.prisoner.first_name }} {{ visit.prisoner.last_name }}
                                        </div>
                                        <small class="text-muted">ID: {{ visit.prisoner.prisoner_id }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info fs-6">
                                            <i class="bi bi-clock me-1"></i>{{ visit.check_in_time|time:"h:i A" }}
                                        </span>
                                        <br><small class="text-muted">{{ visit.check_in_time|date:"M d, Y" }}</small>
                                    </td>
                                    <td class="text-end">
                                        <a href="{% url 'check_out_visitor' visit.id %}" 
                                           class="btn btn-sm btn-warning"
                                           onclick="return confirm('Check out {{ visit.visitor.full_name|default:visit.visitor.username }}?')">
                                            <i class="bi bi-box-arrow-right me-1"></i>Check-Out
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-inbox display-1"></i>
                        <h5 class="mt-3">No visitors currently inside</h5>
                        <p>All visitors have been checked out or no check-ins today.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Approved Visits Awaiting Check-In -->
        <div class="card dashboard-table-card info-header shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-day me-2"></i>
                    Approved for Today - Awaiting Check-In ({{ approved_visits|length|default:0 }})
                </h5>
            </div>
            <div class="card-body">
                {% if approved_visits %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-person me-1"></i>Visitor</th>
                                    <th><i class="bi bi-building me-1"></i>Prisoner</th>
                                    <th><i class="bi bi-clock me-1"></i>Time Slot</th>
                                    <th><i class="bi bi-hash me-1"></i>Visit ID</th>
                                    <th><i class="bi bi-tag me-1"></i>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for visit in approved_visits %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if visit.visitor.profile_photo %}
                                                <img src="{{ visit.visitor.profile_photo.url }}" 
                                                     class="rounded-circle me-2" width="32" height="32" alt="Photo">
                                            {% else %}
                                                <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center" 
                                                     style="width: 32px; height: 32px; color: white; font-size: 14px;">
                                                    {{ visit.visitor.full_name|default:visit.visitor.username|first|upper }}
                                                </div>
                                            {% endif %}
                                            <div>
                                                <div class="visitor-name" style="color: #000000 !important; background: #ffffff !important;">
                                                    {{ visit.visitor.full_name|default:visit.visitor.username }}
                                                </div>
                                                {% if visit.visitor.phone_number %}
                                                    <small class="text-muted">{{ visit.visitor.phone_number }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="prisoner-name" style="color: #000000 !important; background: #ffffff !important;">
                                            {{ visit.prisoner.first_name }} {{ visit.prisoner.last_name }}
                                        </div>
                                        <small class="text-muted">ID: {{ visit.prisoner.prisoner_id }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary fs-6">
                                            <i class="bi bi-clock me-1"></i>{{ visit.visit_time_slot }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary fs-6">{{ visit.id }}</span>
                                    </td>
                                    <td>
                                        {% if visit.visit_type == 'EMERGENCY' %}
                                            <span class="badge bg-danger">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Emergency
                                            </span>
                                        {% else %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-calendar-check me-1"></i>Regular
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-calendar-x display-1"></i>
                        <h5 class="mt-3">No approved visits for today</h5>
                        <p>No visitors are scheduled or all have already checked in.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Emergency Panic Button -->
<button type="button" class="btn emergency-btn" id="panic-btn" 
        title="Emergency Panic Button - Triggers facility-wide alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <span class="d-none d-sm-inline">EMERGENCY</span>
</button>

<!-- Emergency Confirmation Modal -->
<div class="modal fade emergency-modal" id="emergencyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    EMERGENCY ALERT SYSTEM
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="emergency-warning">
                    <div class="emergency-icon">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                    <h4 class="mt-3 mb-3">üö® FACILITY EMERGENCY ALERT üö®</h4>
                    <p class="mb-3">
                        <strong>WARNING:</strong> You are about to trigger a facility-wide emergency alert. 
                        This will immediately notify all administrators, security personnel, and emergency contacts.
                    </p>
                    <div class="alert alert-danger">
                        <strong>This action will:</strong>
                        <ul class="mb-0 mt-2 text-start">
                            <li>Send immediate notifications to all prison staff</li>
                            <li>Alert facility administrators</li>
                            <li>Create an emergency log entry</li>
                            <li>Potentially trigger lockdown procedures</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="emergencyReason" class="form-label">
                        <i class="bi bi-pencil me-2"></i>Emergency Description (Required)
                    </label>
                    <textarea class="form-control" id="emergencyReason" rows="3" 
                              placeholder="Describe the emergency situation (e.g., security breach, medical emergency, violence, fire, etc.)"
                              required></textarea>
                    <div class="form-text">Provide specific details about the emergency for proper response.</div>
                </div>
                
                <div class="text-center">
                    <p class="text-warning mb-3">
                        <i class="bi bi-clock me-1"></i>
                        <strong>Only use in genuine emergencies!</strong>
                    </p>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button type="button" class="btn btn-secondary btn-lg me-3" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger btn-lg" id="confirmEmergencyBtn">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>TRIGGER EMERGENCY ALERT
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Emergency Form -->
<form method="post" id="emergency-form" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="emergency_reason" id="emergency_reason_input">
    <input type="hidden" name="facility_id" value="{{ user.jail.id }}">
    <input type="hidden" name="security_user" value="{{ user.username }}">
</form>

<!-- QR Code Scanner Script -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
'use strict';

// Global variables
let currentVisitId = null;
let debugData = null;
let emergencyActivated = false;

// Global check-in function
window.confirmCheckIn = function(visitId) {
    console.log('Confirming check-in for visit ID:', visitId);
    const visitInput = document.getElementById('visit_id_input');
    const checkinForm = document.getElementById('checkin-form');
    
    if (visitInput && checkinForm) {
        visitInput.value = visitId;
        checkinForm.submit();
    } else {
        console.error('Check-in form elements not found');
        alert('Error: Could not process check-in. Please refresh the page.');
    }
};

// Emergency System Functions
function activateEmergencyAlert(reason) {
    console.log('üö® EMERGENCY ALERT ACTIVATED:', reason);
    
    // Show emergency banner
    const banner = document.getElementById('emergency-alert-banner');
    if (banner) {
        banner.style.display = 'block';
        document.body.style.paddingTop = '60px'; // Adjust for fixed banner
    }
    
    // Update emergency button
    const panicBtn = document.getElementById('panic-btn');
    if (panicBtn) {
        panicBtn.classList.add('activated');
        panicBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ALERT ACTIVE';
        panicBtn.disabled = true;
    }
    
    // Create and submit emergency form
    const form = document.getElementById('emergency-form');
    const reasonInput = document.getElementById('emergency_reason_input');
    
    if (form && reasonInput) {
        // Use Django URL reverse for proper routing
        form.action = '{% url "trigger_emergency_alert" %}';
        reasonInput.value = reason;
        
        // Add timestamp
        const timestampInput = document.createElement('input');
        timestampInput.type = 'hidden';
        timestampInput.name = 'timestamp';
        timestampInput.value = new Date().toISOString();
        form.appendChild(timestampInput);
        
        // Add location
        const locationInput = document.createElement('input');
        locationInput.type = 'hidden';
        locationInput.name = 'location';
        locationInput.value = 'Security Dashboard';
        form.appendChild(locationInput);
        
        console.log('Submitting emergency alert with reason:', reason);
        form.submit();
        
        emergencyActivated = true;
    } else {
        console.error('Emergency form elements not found');
        // Fallback: make AJAX request
        makeEmergencyAjaxRequest(reason);
    }
}

function makeEmergencyAjaxRequest(reason) {
    const emergencyData = {
        emergency_reason: reason,
        facility_id: {{ user.jail.id|default:"null" }},
        security_user: '{{ user.username|escapejs }}',
        timestamp: new Date().toISOString(),
        location: 'Security Dashboard'
    };
    
    fetch('{% url "trigger_emergency_alert" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(emergencyData)
    })
    .then(response => {
        if (response.ok) {
            console.log('Emergency alert sent successfully via AJAX');
            showEmergencySuccess();
        } else {
            throw new Error('Failed to send emergency alert');
        }
    })
    .catch(error => {
        console.error('Emergency alert failed:', error);
        alert('Emergency alert system error. Please contact administrator immediately!');
    });
}

function showEmergencySuccess() {
    // Show success message
    const successAlert = document.createElement('div');
    successAlert.innerHTML = `
        <div class="alert alert-success alert-dismissible fade show position-fixed" 
             style="top: 80px; right: 20px; z-index: 1002; max-width: 400px;">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Emergency Alert Sent!</strong><br>
            All administrators and security personnel have been notified.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    document.body.appendChild(successAlert);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (successAlert.parentNode) {
            successAlert.parentNode.removeChild(successAlert);
        }
    }, 10000);
}

// Debug functions (keeping existing debug functionality)
function debugQRValidation(visitId) {
    console.log('üîç Starting QR validation debug for Visit ID:', visitId);
    
    fetch(`/visitor-management/debug/qr-validation/${visitId}/`)
    .then(response => response.json())
    .then(data => {
        debugData = data;
        console.log('üîç DEBUG DATA:', data);
        document.getElementById('debug-toggle-btn').style.display = 'block';
    })
    .catch(error => {
        console.error('Debug request failed:', error);
    });
}

function showDebugInfo() {
    if (!debugData) return;
    
    const debugSection = document.getElementById('debug-section');
    const debugOutput = document.getElementById('debug-output');
    
    let html = `
        <div class="row mb-4">
            <div class="col-md-6">
                <h6><i class="bi bi-info-circle"></i> Basic Information</h6>
                <ul class="list-group list-group-flush mb-3">
                    <li class="list-group-item d-flex justify-content-between" style="background: var(--bg-input); border-color: var(--border); color: var(--text-white);">
                        <span>Visit ID:</span> <strong>${debugData.visit_id}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between" style="background: var(--bg-input); border-color: var(--border); color: var(--text-white);">
                        <span>Security User:</span> <strong>${debugData.user}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between" style="background: var(--bg-input); border-color: var(--border); color: var(--text-white);">
                        <span>User Facility:</span> <strong>${debugData.user_jail}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between" style="background: var(--bg-input); border-color: var(--border); color: var(--text-white);">
                        <span>Debug Time:</span> <strong>${debugData.timestamp}</strong>
                    </li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-shield-check"></i> Final Result</h6>
                <div class="alert ${debugData.final_result === 'PASS' ? 'alert-success' : 'alert-danger'}">
                    <h5 class="mb-2">
                        ${debugData.final_result === 'PASS' ? '‚úÖ QR CODE VALID' : '‚ùå QR CODE REJECTED'}
                    </h5>
                    <p class="mb-0">${debugData.message}</p>
                </div>
            </div>
        </div>
        
        <h6><i class="bi bi-layers"></i> Security Layer Validation Results</h6>
        <div class="row">`;
    
    let layerCount = 1;
    for (const [layerName, layerData] of Object.entries(debugData.layers)) {
        const layerTitle = layerName.replace('layer_', '').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        const isPass = layerData.status === 'PASS';
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="debug-layer ${isPass ? 'debug-pass' : 'debug-fail'}">
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge ${isPass ? 'bg-success' : 'bg-danger'} me-2">${layerCount}</span>
                        <i class="bi bi-${isPass ? 'check-circle-fill text-success' : 'x-circle-fill text-danger'} me-2"></i>
                        <strong>${layerTitle}</strong>
                    </div>
                    <p class="mb-2">${layerData.message}</p>
                    ${layerData.details ? `
                        <div class="small text-muted">
                            ${Object.entries(layerData.details).map(([key, value]) => 
                                `<div><strong>${key.replace('_', ' ')}:</strong> ${value || 'None'}</div>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>`;
        layerCount++;
    }
    
    html += '</div>';
    debugOutput.innerHTML = html;
    debugSection.style.display = 'block';
    debugSection.scrollIntoView({ behavior: 'smooth' });
}

function hideDebug() {
    document.getElementById('debug-section').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîí Security Dashboard with Enhanced Emergency System loaded');
    console.log('Data summary:', {
        currentlyInside: {{ current_visitor_count|default:0 }},
        approvedVisits: {{ approved_visits|length|default:0 }}
    });
    
    // Force name visibility
    const visitorNames = document.querySelectorAll('.visitor-name');
    const prisonerNames = document.querySelectorAll('.prisoner-name');
    
    visitorNames.forEach(name => {
        name.style.color = '#000000';
        name.style.background = '#ffffff';
        name.style.fontWeight = '800';
        name.style.padding = '0.4rem 0.8rem';
        name.style.borderRadius = '6px';
        name.style.display = 'inline-block';
        name.style.border = '1px solid #555';
    });
    
    prisonerNames.forEach(name => {
        name.style.color = '#000000';
        name.style.background = '#ffffff';
        name.style.fontWeight = '800';
        name.style.padding = '0.4rem 0.8rem';
        name.style.borderRadius = '6px';
        name.style.display = 'inline-block';
        name.style.border = '1px solid #555';
    });
    
    // Get DOM elements
    const fileInput = document.getElementById('qr-image-input');
    const verifyBtn = document.getElementById('verify-qr-button');
    const resultArea = document.getElementById('verification-area');
    const panicBtn = document.getElementById('panic-btn');
    const debugToggleBtn = document.getElementById('debug-toggle-btn');
    const emergencyModal = document.getElementById('emergencyModal');
    const confirmEmergencyBtn = document.getElementById('confirmEmergencyBtn');
    const emergencyReasonTextarea = document.getElementById('emergencyReason');
    
    // Validate required elements
    if (!fileInput || !verifyBtn || !resultArea || !panicBtn) {
        console.error('Required DOM elements not found');
        return;
    }
    
    // Enhanced Emergency Panic Button Handler
    panicBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üö® Emergency panic button clicked');
        
        if (emergencyActivated) {
            alert('Emergency alert already active! Help is on the way.');
            return;
        }
        
        // Show the emergency modal
        const modal = new bootstrap.Modal(emergencyModal);
        modal.show();
        
        // Focus on the reason textarea
        setTimeout(() => {
            emergencyReasonTextarea.focus();
        }, 500);
    });
    
    // Confirm Emergency Button Handler
    if (confirmEmergencyBtn && emergencyReasonTextarea) {
        confirmEmergencyBtn.addEventListener('click', function() {
            const reason = emergencyReasonTextarea.value.trim();
            
            if (!reason || reason.length < 10) {
                alert('Please provide a detailed description of the emergency (minimum 10 characters).');
                emergencyReasonTextarea.focus();
                return;
            }
            
            // Final confirmation
            const finalConfirm = confirm(
                'üö® FINAL CONFIRMATION üö®\n\n' +
                'Are you absolutely sure you want to trigger a facility-wide emergency alert?\n\n' +
                'Emergency: ' + reason + '\n\n' +
                'This will immediately notify all security personnel and administrators!'
            );
            
            if (finalConfirm) {
                // Hide the modal
                const modal = bootstrap.Modal.getInstance(emergencyModal);
                modal.hide();
                
                // Activate emergency system
                activateEmergencyAlert(reason);
            }
        });
    }
    
    // Initialize QR Code scanner (keeping existing QR functionality)
    let html5QrCode = null;
    try {
        const dummyQrReader = document.createElement('div');
        dummyQrReader.id = 'qr-reader-dummy';
        dummyQrReader.style.display = 'none';
        dummyQrReader.setAttribute('aria-hidden', 'true');
        document.body.appendChild(dummyQrReader);
        
        html5QrCode = new Html5Qrcode('qr-reader-dummy');
        console.log('QR Code scanner initialized successfully');
    } catch (error) {
        console.error('QR scanner initialization failed:', error);
    }

    // Debug toggle button handler
    if (debugToggleBtn) {
        debugToggleBtn.addEventListener('click', function() {
            if (debugData) {
                showDebugInfo();
            }
        });
    }

    // File input change handler
    fileInput.addEventListener('change', function() {
        const hasFile = this.files.length > 0;
        verifyBtn.disabled = !hasFile;
        
        if (hasFile) {
            verifyBtn.classList.remove('btn-secondary');
            verifyBtn.classList.add('btn-primary');
            console.log('QR image selected:', this.files[0].name);
            
            // Show ready state
            resultArea.innerHTML = `
                <div class="alert alert-primary">
                    <i class="bi bi-file-earmark-image me-2"></i>
                    <strong>Image Ready:</strong> ${this.files[0].name}
                    <br><small>Click "Verify" to begin 6-layer security validation</small>
                </div>`;
        } else {
            verifyBtn.classList.remove('btn-primary');
            verifyBtn.classList.add('btn-secondary');
            if (debugToggleBtn) debugToggleBtn.style.display = 'none';
            hideDebug();
        }
    });

    // QR Code verification handler (keeping existing functionality)
    verifyBtn.addEventListener('click', function() {
        console.log('Starting QR verification process');
        
        if (fileInput.files.length === 0) {
            alert('Please select a QR code image first!');
            fileInput.focus();
            return;
        }
        
        // Disable button and show processing
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Processing...';
        
        const imageFile = fileInput.files[0];
        
        // Show scanning progress
        resultArea.innerHTML = `
            <div class="alert alert-warning">
                <div class="d-flex align-items-center">
                    <span class="spinner-border spinner-border-sm me-3"></span>
                    <div>
                        <strong>Security Verification in Progress...</strong>
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 style="width: 60%"></div>
                        </div>
                        <small class="text-muted mt-1 d-block">Scanning QR code and validating through 6 security layers...</small>
                    </div>
                </div>
            </div>`;
        
        if (!html5QrCode) {
            showError('QR scanner not available. Please refresh the page and try again.');
            resetVerifyButton();
            return;
        }

        // Scan QR code
        html5QrCode.scanFile(imageFile, true)
        .then(function(decodedText) {
            console.log('QR Code decoded successfully:', decodedText);
            
            // Layer 1: Format validation
            const visitIdMatch = decodedText.match(/Visit\s*ID[:\s]*(\d+)/i);
            if (visitIdMatch && visitIdMatch[1]) {
                const visitId = visitIdMatch[1];
                currentVisitId = visitId;
                console.log('‚úì Layer 1 passed: Valid format, Visit ID:', visitId);
                
                // Start debug process
                debugQRValidation(visitId);
                
                // Proceed to database verification
                fetchAndValidateVisit(visitId);
            } else {
                console.log('‚úó Layer 1 failed: Invalid QR format');
                showError('Invalid QR Code format detected. Expected: "Visit ID: [number]"');
            }
        })
        .catch(function(err) {
            console.error('QR scan failed:', err);
            showError('Could not read QR code. Please ensure image is clear and contains a valid QR code.');
        })
        .finally(function() {
            resetVerifyButton();
        });
    });

    // Keep existing QR validation functions
    function fetchAndValidateVisit(visitId) {
        console.log('Starting database validation for Visit ID:', visitId);
        
        const apiUrl = `/visitor-management/api/visit-details/${visitId}/`;
        
        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(function(response) {
            console.log('API response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`Validation failed: HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(function(data) {
            console.log('‚úì All validation layers passed:', data);
            
            if (data.error) {
                console.log('‚úó Validation failed:', data.error);
                showError(data.error);
            } else {
                console.log('‚úì Visit verified successfully - displaying details');
                displayVerifiedVisitor(data);
            }
        })
        .catch(function(err) {
            console.error('‚úó Database validation failed:', err);
            showError('Verification failed: Could not validate visit details with secure database.');
        });
    }

    // Enhanced display function with complete visitor and prisoner details
    function displayVerifiedVisitor(data) {
        // Visitor photo with fallback
        const visitorPhotoHtml = data.visitor_photo_url ? 
            `<img src="${data.visitor_photo_url}" class="rounded-circle visitor-photo mb-3" width="120" height="120" alt="Visitor Photo">` :
            `<div class="bg-success rounded-circle visitor-photo mb-3 mx-auto d-flex align-items-center justify-content-center" 
                  style="width: 120px; height: 120px; color: white; font-size: 36px;">${data.visitor_name.charAt(0).toUpperCase()}</div>`;
        
        // Prisoner photo with fallback
        const prisonerPhotoHtml = data.prisoner_photo_url ? 
            `<img src="${data.prisoner_photo_url}" class="rounded-circle prisoner-photo mb-3" width="120" height="120" alt="Prisoner Photo">` :
            `<div class="bg-secondary rounded-circle prisoner-photo mb-3 mx-auto d-flex align-items-center justify-content-center" 
                  style="width: 120px; height: 120px; color: white; font-size: 36px;">${data.prisoner_name.charAt(0).toUpperCase()}</div>`;
        
        resultArea.innerHTML = `
            <div class="verification-card">
                <div class="card">
                    <div class="card-body">
                        <div class="security-badge mb-4 text-center">
                            <i class="bi bi-shield-check me-1"></i>SECURITY VERIFIED
                        </div>
                        <h5 class="card-title text-success mb-4 text-center">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Identity Verification Required
                        </h5>
                        
                        <!-- Visitor & Prisoner Details Side by Side -->
                        <div class="row mb-4">
                            <div class="col-md-6 visitor-section">
                                <div class="person-card">
                                    ${visitorPhotoHtml}
                                    <h6 class="mb-2">
                                        <i class="bi bi-person-fill text-primary me-1"></i>
                                        <strong>Visitor</strong>
                                    </h6>
                                    <p class="mb-1 fw-bold">${escapeHtml(data.visitor_name)}</p>
                                    ${data.visitor_details && data.visitor_details.phone ? `<p class="text-muted mb-1"><i class="bi bi-telephone"></i> ${escapeHtml(data.visitor_details.phone)}</p>` : ''}
                                    ${data.visitor_details && data.visitor_details.email ? `<p class="text-muted mb-1"><i class="bi bi-envelope"></i> ${escapeHtml(data.visitor_details.email)}</p>` : ''}
                                    <span class="badge bg-info">${data.visitor_details && data.visitor_details.role ? escapeHtml(data.visitor_details.role) : 'Visitor'}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="person-card">
                                    ${prisonerPhotoHtml}
                                    <h6 class="mb-2">
                                        <i class="bi bi-building text-secondary me-1"></i>
                                        <strong>Prisoner</strong>
                                    </h6>
                                    <p class="mb-1 fw-bold">${escapeHtml(data.prisoner_name)}</p>
                                    <p class="text-muted mb-1"><i class="bi bi-person-badge"></i> ID: ${data.prisoner_details && data.prisoner_details.prisoner_id ? escapeHtml(data.prisoner_details.prisoner_id) : 'N/A'}</p>
                                    ${data.prisoner_details && data.prisoner_details.cell_number ? `<p class="text-muted mb-1"><i class="bi bi-house"></i> Cell: ${escapeHtml(data.prisoner_details.cell_number)}</p>` : ''}
                                    <p class="text-muted mb-1"><i class="bi bi-building"></i> ${data.prisoner_details && data.prisoner_details.jail_name ? escapeHtml(data.prisoner_details.jail_name) : 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Visit Details -->
                        <div class="alert alert-info mb-3">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <i class="bi bi-clock text-info"></i>
                                    <strong>Time:</strong><br>${escapeHtml(data.visit_time_slot)}
                                </div>
                                <div class="col-md-4">
                                    <i class="bi bi-calendar text-info"></i>
                                    <strong>Date:</strong><br>${escapeHtml(data.visit_date || 'Today')}
                                </div>
                                <div class="col-md-4">
                                    <i class="bi bi-tag text-info"></i>
                                    <strong>Type:</strong><br>${escapeHtml(data.visit_type || 'Regular')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Security Check Warning -->
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-eye-fill me-2"></i>
                            <strong>Final Security Check:</strong> Visually confirm this person matches the visitor in front of you.
                            <br><small class="text-muted">Compare the visitor's face with the photo above and verify their identity documents.</small>
                        </div>
                        
                        <!-- Action Button -->
                        <button class="btn btn-success btn-lg w-100 shadow" 
                                onclick="confirmCheckIn(${data.visit_id})" 
                                type="button">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Confirm Identity & Check-In
                        </button>
                        
                        <div class="mt-2 text-center">
                            <small class="text-muted">
                                <i class="bi bi-shield-check me-1"></i>
                                6-Layer security verification completed successfully
                            </small>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    // Show security error
    function showError(message) {
        resultArea.innerHTML = `
            <div class="alert alert-danger">
                <div class="d-flex align-items-center">
                    <i class="bi bi-shield-x fs-3 me-3 text-danger"></i>
                    <div>
                        <strong>Security Verification Failed</strong>
                        <p class="mb-1">${escapeHtml(message)}</p>
                        <small class="text-muted">This QR code failed one or more security validation layers. Check debug info for details.</small>
                    </div>
                </div>
            </div>`;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Reset verify button state
    function resetVerifyButton() {
        const hasFile = fileInput.files.length > 0;
        verifyBtn.disabled = !hasFile;
        verifyBtn.innerHTML = '<i class="bi bi-search me-1"></i>Verify';
        fileInput.value = '';
        
        if (!hasFile) {
            verifyBtn.classList.remove('btn-primary');
            verifyBtn.classList.add('btn-secondary');
            if (debugToggleBtn) debugToggleBtn.style.display = 'none';
            
            // Reset to initial state
            resultArea.innerHTML = `
                <div class="alert alert-secondary text-center">
                    <i class="bi bi-shield-check fs-3 text-muted"></i>
                    <p class="mb-2 mt-2"><strong>Multi-Layer Security Verification</strong></p>
                    <p class="mb-0 small">Upload QR code to begin 6-layer authentication process</p>
                </div>`;
        }
    }

    // Page visibility handler
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            console.log('Security dashboard back in focus');
        }
    });
    
    // Keyboard shortcuts for emergency
    document.addEventListener('keydown', function(e) {
        // Ctrl + Shift + E for emergency
        if (e.ctrlKey && e.shiftKey && e.key === 'E') {
            e.preventDefault();
            panicBtn.click();
        }
    });
});

// Global error handler
window.addEventListener('error', function(e) {
    console.error('JavaScript error in security dashboard:', e.error);
});

// Security logging
console.log('üîí E-Prison Security Dashboard with Enhanced Emergency System initialized');
</script>
{% endblock %}
